[
    {
        "title": "$:/plugins/Gk0Wk/page-toc/PageTOCWidget.js",
        "module-type": "widget",
        "type": "application/javascript",
        "Modern.TiddlyDev#Origin": "PageTOCWidget.ts",
        "text": "\"use strict\";var import_widget=require(\"$:/core/modules/widgets/widget.js\"),PageTOCWidget=class extends import_widget.widget{constructor(){super(...arguments),this.tocNodeTag=\"div\",this.tocHeaderNodeTag=\"p\",this.tocNodeClass=\"gk0wk-tiddlertoc-container\",this.tocHeaderNodeClassPrefix=\"gk0wk-tiddlertoc-\",this.tocTitle=\"\",this.emptyMessage=\"\",this.scrollMode=\"center\",this.includeHeaderMap={h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0}}initialise(e,t){super.initialise(e,t),this.computeAttributes()}execute(){this.tocTitle=this.getAttribute(\"tiddler\",this.getVariable(\"currentTiddler\")),this.tocNodeTag=this.getAttribute(\"tag\",\"div\"),$tw.config.htmlUnsafeElements.includes(this.tocNodeTag)&&(this.tocNodeTag=\"div\"),this.tocHeaderNodeTag=this.getAttribute(\"headerTag\",\"p\"),$tw.config.htmlUnsafeElements.includes(this.tocHeaderNodeTag)&&(this.tocHeaderNodeTag=\"p\"),this.tocNodeClass=this.getAttribute(\"class\",\"gk0wk-tiddlertoc-container\"),this.tocHeaderNodeClassPrefix=this.getAttribute(\"headerClassPrefix\",\"gk0wk-tiddlertoc-\"),this.emptyMessage=this.getAttribute(\"emptyMessage\",\"\"),this.includeHeaderMap.h1=\"yes\"===this.getAttribute(\"h1\",\"yes\"),this.includeHeaderMap.h2=\"yes\"===this.getAttribute(\"h2\",\"yes\"),this.includeHeaderMap.h3=\"yes\"===this.getAttribute(\"h3\",\"yes\"),this.includeHeaderMap.h4=\"yes\"===this.getAttribute(\"h4\",\"yes\"),this.includeHeaderMap.h5=\"yes\"===this.getAttribute(\"h5\",\"yes\"),this.includeHeaderMap.h6=\"yes\"===this.getAttribute(\"h6\",\"yes\"),this.scrollMode=this.getAttribute(\"scrollMode\",\"center\"),[\"start\",\"center\",\"end\",\"nearest\"].includes(this.scrollMode)||(this.scrollMode=\"center\")}render(e,i){if(this.parentDomNode=e,this.execute(),this.parentWidget.hasVariable(\"page-toc-recursion-detection\",\"yes\"))this.domNodes.push(e.appendChild(this.document.createTextNode(\"[Page TOC]\")));else{this.setVariable(\"page-toc-recursion-detection\",\"yes\");var s=$tw.utils.domMaker(this.tocNodeTag,{\"class\":this.tocNodeClass});this.domNodes.push(s);try{const o=this.getTOCInfo();if(o&&0!==o.headers.length)for(let e=0,t=o.headers.length;e<t;e++){const{tag:d,text:l,count:a}=o.headers[e];var r=$tw.utils.domMaker(this.tocHeaderNodeTag,{\"class\":\"\"+this.tocHeaderNodeClassPrefix+d,text:l});$tw.browser&&r.addEventListener(\"click\",()=>{var e,t,i=null==(t=null==(e=null==(t=document.querySelector(`.tc-tiddler-frame[data-tiddler-title=\"${o.title.replace('\"','\\\\\"')}\"]`))?void 0:t.querySelectorAll)?void 0:e.call(t,\".tc-tiddler-body \"+d))?void 0:t[a];if(i)switch(this.scrollMode){case\"center\":case\"nearest\":i.scrollIntoView({behavior:\"smooth\",block:this.scrollMode});break;default:i.scrollIntoView({behavior:\"auto\",block:this.scrollMode}),\"end\"===this.scrollMode?(document.body.scrollTop+=100,document.scrollingElement&&(document.scrollingElement.scrollTop+=100)):(document.body.scrollTop-=100,document.scrollingElement&&(document.scrollingElement.scrollTop-=100))}}),s.appendChild(r)}else s.insertBefore($tw.utils.domMaker(this.tocHeaderNodeTag,{\"class\":this.tocHeaderNodeClassPrefix+\"empty\",text:this.emptyMessage}),i)}catch(t){console.error(t),s.textContent=String(t)}e.insertBefore(s,i)}}refresh(e){var t=this.computeAttributes();return 0<$tw.utils.count(t)||Object.hasOwnProperty.call(t,this.tocTitle)?(this.refreshSelf(),this.refreshChildren(e),!0):this.refreshChildren(e)}getTOCInfo(){if(\"\"!==this.tocTitle){var e=$tw.wiki.getTiddler(this.tocTitle);if(e){var e=e.fields.type||\"text/vnd.tiddlywiki\",t=(null==(t=$tw.config.contentTypeInfo[e])?void 0:t.deserializerType)||e;if(\"text/vnd.tiddlywiki\"===t||\"text/x-markdown\"===t){for(var i=[],s={h1:0,h2:0,h3:0,h4:0,h5:0,h6:0},e=$tw.wiki.parseTiddler(this.tocTitle).tree,t=$tw.wiki.makeWidget({tree:e}),e=$tw.fakeDocument.createElement(\"div\"),r=(t.render(e,null),[e]);0<r.length;){var o=r.pop();if(/^h[1-6]$/.test(o.tagName)&&(console.log(o),i.push({tag:o.tagName,count:s[o.tagName]++,text:o.textContent||\"\"})),Array.isArray(o.children))for(let e=o.children.length-1;0<=e;e--)r.push(o.children[e])}return{title:this.tocTitle,headers:i}}}}}};exports[\"page-toc\"]=PageTOCWidget;"
    }
]